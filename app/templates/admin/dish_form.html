{% extends "admin/base.html" %}

{% block title %}{{ 'Редактировать' if dish else 'Новое' }} блюдо{% endblock %}

{% block breadcrumbs %}
<a href="/admin" class="admin-breadcrumbs__item">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
    </svg>
</a>
<span class="admin-breadcrumbs__separator">/</span>
<a href="/admin/dishes" class="admin-breadcrumbs__item">Блюда</a>
<span class="admin-breadcrumbs__separator">/</span>
<span class="admin-breadcrumbs__current">{{ 'Редактирование' if dish else 'Создание' }}</span>
{% endblock %}

{% block content %}
<form method="POST" action="{{ '/admin/dishes/' ~ dish.id if dish else '/admin/dishes' }}" enctype="multipart/form-data" id="dishForm" class="form-page">
    <!-- Sticky Header -->
    <div class="form-sticky-header">
        <div class="form-sticky-header__left">
            <a href="/admin/dishes" class="btn btn--icon" title="Назад к списку">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
            </a>
            <div class="form-sticky-header__title">
                <h1>{{ 'Редактировать блюдо' if dish else 'Новое блюдо' }}</h1>
                <span class="form-sticky-header__status" id="formStatus">
                    {% if dish %}
                    <span class="status-dot status-dot--{{ 'success' if dish.is_available else 'warning' }}"></span>
                    {{ 'В наличии' if dish.is_available else 'Нет в наличии' }}
                    {% else %}
                    Черновик
                    {% endif %}
                </span>
            </div>
        </div>
        <div class="form-sticky-header__actions">
            <a href="/admin/dishes" class="btn btn--secondary">Отмена</a>
            <button type="submit" class="btn btn--primary" id="submitBtn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                {{ 'Сохранить' if dish else 'Создать' }}
            </button>
        </div>
    </div>

    <div class="form-layout">
        <!-- Main Content -->
        <div class="form-layout__main">
            <!-- Basic Info -->
            <div class="form-card">
                <div class="form-card__header">
                    <h3 class="form-card__title">Основная информация</h3>
                </div>
                <div class="form-card__body">
                    <div class="form-group">
                        <label class="form-label form-label--required" for="name">Название</label>
                        <input type="text" id="name" name="name" class="form-input" placeholder="Например: Борщ украинский"
                               value="{{ dish.name if dish else '' }}" required maxlength="200">
                        <p class="form-hint"><span id="nameCount">0</span>/200 символов</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label form-label--required" for="category_id">Категория</label>
                        <select id="category_id" name="category_id" class="form-input form-select" required>
                            <option value="">Выберите категорию</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}" {{ 'selected' if dish and dish.category_id == cat.id else '' }}>
                                {{ cat.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="description">Описание</label>
                        <textarea id="description" name="description" class="form-input form-textarea"
                                  placeholder="Опишите состав, особенности приготовления или подачи блюда"
                                  rows="4" maxlength="1000">{{ dish.description if dish else '' }}</textarea>
                        <p class="form-hint"><span id="descCount">0</span>/1000 символов</p>
                    </div>
                </div>
            </div>

            <!-- Price & Characteristics -->
            <div class="form-card">
                <div class="form-card__header">
                    <h3 class="form-card__title">Цена и характеристики</h3>
                </div>
                <div class="form-card__body">
                    <div class="form-row form-row--3">
                        <div class="form-group">
                            <label class="form-label form-label--required" for="price">Цена</label>
                            <div class="form-input-group">
                                <input type="number" id="price" name="price" class="form-input" step="1" min="0" placeholder="0"
                                       value="{{ dish.price|int if dish else '' }}" required>
                                <span class="form-input-group__addon">₽</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="weight">Вес / объем</label>
                            <input type="text" id="weight" name="weight" class="form-input" placeholder="250г / 300мл"
                                   value="{{ dish.weight if dish else '' }}">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="calories">Калорийность</label>
                            <div class="form-input-group">
                                <input type="number" id="calories" name="calories" class="form-input" min="0" placeholder="0"
                                       value="{{ dish.calories if dish else '' }}">
                                <span class="form-input-group__addon">ккал</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Image Upload -->
            <div class="form-card">
                <div class="form-card__header">
                    <h3 class="form-card__title">Изображение</h3>
                </div>
                <div class="form-card__body">
                    <div class="image-upload-area" id="imageUploadArea">
                        {% if dish and dish.image_medium %}
                        <div class="image-upload-preview" id="imagePreview">
                            <img src="{{ dish.image_medium }}" alt="{{ dish.name }}" id="previewImg">
                            <div class="image-upload-preview__overlay">
                                <button type="button" class="btn btn--secondary btn--small" onclick="document.getElementById('image').click()">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                    Заменить
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <div class="image-upload-placeholder" id="imagePlaceholder">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                            <p>Перетащите изображение сюда</p>
                            <span>или</span>
                            <button type="button" class="btn btn--secondary btn--small" onclick="document.getElementById('image').click()">
                                Выбрать файл
                            </button>
                            <p class="form-hint">JPG, PNG или WebP. Максимум 5MB</p>
                        </div>
                        {% endif %}
                        <input type="file" id="image" name="image" accept="image/*" class="u-hidden" onchange="previewImage(this)">
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="form-layout__sidebar">
            <!-- Status -->
            <div class="form-card">
                <div class="form-card__header">
                    <h3 class="form-card__title">Статус</h3>
                </div>
                <div class="form-card__body">
                    <div class="form-toggle-group">
                        <label class="form-toggle">
                            <input type="checkbox" name="is_available" value="true" id="isAvailable"
                                   {{ 'checked' if not dish or dish.is_available else '' }}>
                            <span class="form-toggle__slider"></span>
                            <span class="form-toggle__label">
                                <strong>В наличии</strong>
                                <small>Блюдо доступно для заказа</small>
                            </span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Sort Order -->
            <div class="form-card">
                <div class="form-card__header">
                    <h3 class="form-card__title">Сортировка</h3>
                </div>
                <div class="form-card__body">
                    <div class="form-group">
                        <label class="form-label" for="sort_order">Порядок</label>
                        <input type="number" id="sort_order" name="sort_order" class="form-input" min="0"
                               value="{{ dish.sort_order if dish else 0 }}">
                        <p class="form-hint">Меньшее число = выше в списке</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
// Character counters
const nameInput = document.getElementById('name');
const descInput = document.getElementById('description');
const nameCount = document.getElementById('nameCount');
const descCount = document.getElementById('descCount');

function updateCounts() {
    if (nameInput && nameCount) {
        nameCount.textContent = nameInput.value.length;
    }
    if (descInput && descCount) {
        descCount.textContent = descInput.value.length;
    }
}

nameInput?.addEventListener('input', updateCounts);
descInput?.addEventListener('input', updateCounts);
updateCounts();

// Image preview
function previewImage(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];

        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
            toast.error('Файл слишком большой', 'Максимальный размер файла — 5MB');
            input.value = '';
            return;
        }

        // Validate file type
        if (!file.type.startsWith('image/')) {
            toast.error('Неверный формат', 'Загрузите изображение (JPG, PNG или WebP)');
            input.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const uploadArea = document.getElementById('imageUploadArea');
            const placeholder = document.getElementById('imagePlaceholder');
            let preview = document.getElementById('imagePreview');

            if (placeholder) {
                placeholder.remove();
            }

            if (!preview) {
                preview = document.createElement('div');
                preview.id = 'imagePreview';
                preview.className = 'image-upload-preview';
                preview.innerHTML = `
                    <img src="" alt="Preview" id="previewImg">
                    <div class="image-upload-preview__overlay">
                        <button type="button" class="btn btn--secondary btn--small" onclick="document.getElementById('image').click()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            Заменить
                        </button>
                    </div>
                `;
                uploadArea.appendChild(preview);
            }

            document.getElementById('previewImg').src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

// Drag and drop for image
const uploadArea = document.getElementById('imageUploadArea');
if (uploadArea) {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.add('image-upload-area--highlight'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('image-upload-area--highlight'), false);
    });

    uploadArea.addEventListener('drop', function(e) {
        const file = e.dataTransfer.files[0];
        if (file) {
            const input = document.getElementById('image');
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            input.files = dataTransfer.files;
            previewImage(input);
        }
    }, false);
}

// Update status text when checkbox changes
const isAvailable = document.getElementById('isAvailable');
const formStatus = document.getElementById('formStatus');
if (isAvailable && formStatus) {
    isAvailable.addEventListener('change', function() {
        const statusClass = this.checked ? 'success' : 'warning';
        const statusText = this.checked ? 'В наличии' : 'Нет в наличии';
        formStatus.innerHTML = `<span class="status-dot status-dot--${statusClass}"></span>${statusText}`;
    });
}

// Form validation
const form = document.getElementById('dishForm');
form?.addEventListener('submit', function(e) {
    const price = document.getElementById('price').value;
    if (parseFloat(price) <= 0) {
        e.preventDefault();
        toast.error('Ошибка валидации', 'Цена должна быть больше 0');
        return;
    }
});
</script>
{% endblock %}
