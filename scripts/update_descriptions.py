"""
Скрипт обновления описаний блюд из PDF с детальной граммовкой ингредиентов (столбиком)
"""
import asyncio
import sys
sys.path.insert(0, '/Users/denisstorozev/Desktop/Проекты /PythonProject14')

from sqlalchemy import select, update
from app.database import async_session, init_db
from app.models import Dish

# Данные из PDF с полной граммовкой ингредиентов (столбиком)
DISH_UPDATES = {
    # ==================== ЗАКУСКИ/САЛАТЫ ====================
    "Микс салат из свежих овощей": {
        "weight": "190 г",
        "description": """Айсберг — 50г
Перец болгарский свежий — 40г
Помидоры черри — 50г
Огурец свежий — 30г
Микрозелень горошка
Семечки тыквенные — 5г
Соус базиликовый или масло оливковое — 15г"""
    },
    "Микс салат с филе утки и маринованным печеным перцем": {
        "weight": "230 г",
        "description": """Айсберг — 50г
Перец болгарский маринованный печёный — 50г
Помидоры черри — 50г
Филе утки обжаренное — 60г
Руккола — 5г
Соус бальзамик или масло оливковое — 15г"""
    },
    "Микс салат с фермерской брынзой": {
        "weight": "210 г",
        "description": """Айсберг — 50г
Перец болгарский свежий — 40г
Помидоры черри — 50г
Соус базиликовый — 15г
Микрозелень горошка
Семечки тыквенные — 5г
Брынза несолёная — 50г"""
    },
    "Хот дог \"Немецкий\"": {
        "weight": "205 г",
        "description": """Булочка хот-дог — 60г
Капуста маринованная — 20г
Кёнигсбергская колбаска (свинина) — 75г
Огурец маринованный — 15г
Соус розовый — 20г
Лук криспи — 5г
Горчица — 10г"""
    },
    "Хот дог с двумя колбасками и тушеной квашеной капустой": {
        "weight": "220 г",
        "description": """Булочка хот-дог — 60г
Капуста квашеная тушёная — 25г
Нюрнбергские колбаски белые (свинина) 2 шт — 80г
Помидор — 20г
Соус розовый — 10г
Лук криспи — 5г
Горчица — 20г"""
    },

    # ==================== СУПЫ ====================
    "Похлебка прусская на местной рыбе": {
        "weight": "360 г",
        "description": """Похлёбка (бульон рыбный, картофель, морковь, сельдерей, лук репчатый) — 300г
Судак филе (возможна замена на филе трески) — 60г
Укроп
Хлеб поджаренный — 1 шт"""
    },
    "Суп немецкий на говяжьем бульоне с колбасками и грибами": {
        "weight": "360 г",
        "description": """Суп немецкий (бульон говяжий костный, сыр чеддер, сливки, картофель, морковь, лук репчатый, шампиньоны) — 300г
Нюрнбергские колбаски (свинина) — 25г
Кёнигсбергские колбаски (свинина) — 25г
Яйцо перепелиное отварное — 10г
Хлеб поджаренный — 1 шт"""
    },
    "Тыквенный суп с семечками": {
        "weight": "300 г",
        "description": "Нежный крем-суп из запечённой тыквы с тыквенными семечками."
    },
    "Тыквенный суп с беконом": {
        "weight": "340 г",
        "description": "Нежный крем-суп из запечённой тыквы с хрустящим беконом."
    },

    # ==================== ГОРЯЧЕЕ ====================
    "Клопсы \"Балтийские\" из местной рыбы под сливочным соусом с каперсами и картофелем": {
        "weight": "390 г",
        "description": """Клопсы рыбные (судак, треска, палтус 35/35/30, сухари, яйцо, лук, сливки, специи) — 110г
Соус сливочный с каперсами и лимоном — 80г
Картофельное пюре — 150г
Салат из маринованной свёклы — 40г
Лимон долька — 10г"""
    },
    "Клопсы \"Де Прусс\" из оленины и свинины под соусом из белых грибов с картофелем": {
        "weight": "390 г",
        "description": """Клопсы мясные (оленина/свинина, сухари, молоко, яйцо, масло сливочное, лук, мускатный орех, специи) — 120г
Соус из белых грибов и шампиньонов — 80г
Картофельное пюре — 150г
Салат из маринованной свёклы — 40г"""
    },
    "Филе скумбрии г/к под пикантным соусом с картофельным пюре и салатом из маринованной свеклы": {
        "weight": "340 г",
        "description": """Скумбрия г/к — 100г
Картофельное пюре — 150г
Салат из маринованной свёклы — 40г
Руккола — 5г
Тайский соус (кунжутное масло, горчица, чили, кинза) — 45г"""
    },
    "Ребра \"Пивные\" копчено-томленые с капустой и картофелем": {
        "weight": "440 г",
        "description": """Рёбра копчёные томлёные — 200г
Картофельное пюре — 100г
Капуста квашеная тушёная — 100г
Лук криспи — 5г
Соус розовый — 25г
Хлеб поджаренный — 10г"""
    },
    "Нюрнбергские колбаски (белые, свинина) гарнир на выбор": {
        "weight": "360 г",
        "description": """Нюрнбергские колбаски (свинина, майоран, без нитритов) — 150г
Картофельное пюре — 120г
Соус на выбор (розовый или горчица) — 30г
Капуста маринованная — 30г
Лук маринованный — 30г"""
    },
    "Кёнигсбергские колбаски (свинина) гарнир на выбор": {
        "weight": "390 г",
        "description": """Кёнигсбергские колбаски (свинина, специи) — 150г
Картофельное пюре — 150г
Лук маринованный — 30г
Огурец маринованный — 30г
Соус на выбор (розовый или горчица) — 30г"""
    },
    "Немецкие колбаски XXL (свинина/курица) с капустой и картофелем": {
        "weight": "560 г",
        "description": """Немецкая колбаска (курица/свинина 65/35) — 250г
Картофельное пюре — 100г
Капуста квашеная тушёная — 100г
Огурец маринованный — 30г
Лук маринованный — 30г
Соус розовый — 20г
Соус горчица — 20г
Хлеб — 9г"""
    },
    "Бургер с фермерской говядиной": {
        "weight": "385 г",
        "description": """Котлета из фермерской говядины — 135г
Булочка бриошь — 85г
Сыр чеддер — 25г
Помидор — 30г
Огурец маринованный — 30г
Лук маринованный — 30г
Соус розовый — 50г"""
    },
    "Бургер куриный под соусом из свежего базилика": {
        "weight": "275 г",
        "description": """Котлета куриная — 110г
Булочка бриошь — 55г
Сыр чеддер — 25г
Помидор — 30г
Айсберг — 15г
Соус зелёный (горчица дижонская, базилик свежий) — 40г"""
    },

    # ==================== АВТОРСКАЯ БРИОШЬ ====================
    "\"Любимая утка Канта\" под соусом из свежего базилика": {
        "weight": "295 г",
        "description": """Булочка бриошь — 110г
Утиная грудка с тимьяном — 90г
Помидор — 30г
Руккола — 10г
Лук криспи — 5г
Соус базиликовый — 50г"""
    },
    "С рваной говядиной, руколой, маринованным луком и огурцом": {
        "weight": "345 г",
        "description": """Булочка бриошь — 100г
Рваная говядина — 90г
Помидор — 30г
Огурец маринованный — 30г
Лук маринованный — 30г
Руккола — 10г
Соус розовый — 50г
Лук криспи — 5г"""
    },
    "С нежным филе сельди и маринованным луком под лимонно-горчичной заправкой": {
        "weight": "275 г",
        "description": """Булочка бриошь — 100г
Сельдь слабосолёная — 80г
Руккола — 10г
Лук маринованный — 30г
Лук зелёный — 5г
Соус лимонно-горчичный (горчица дижонская, сок лимона) — 50г"""
    },
    "Рубанина из пеламиды под лимонно-горчичной заправкой": {
        "weight": "240 г",
        "description": """Рубанина из пеламиды — 80г
Булочка бриошь 1/2 — 60г
Лук маринованный — 30г
Руккола — 10г
Соус лимонно-горчичный — 40г
Лук зелёный — 5г
Лимон — 15г"""
    },
    "С ароматным филе скумбрии г/к под пикантным соусом из свежей кинзы": {
        "weight": "325 г",
        "description": """Булочка бриошь — 100г
Филе скумбрии г/к — 100г
Руккола — 10г
Помидор — 30г
Лук маринованный — 30г
Тайский соус (кунжутное масло, чили, кинза) — 50г
Лук криспи — 5г"""
    },

    # ==================== ЗАКУСКИ ====================
    "Риет из филе скумбрии г/к с поджаренным хлебом и свежим огурцом": {
        "weight": "150 г",
        "description": "Нежный риет из копчёной скумбрии. Подаётся с хрустящим поджаренным хлебом и свежим огурцом."
    },
    "Паштет из куриной печени с вяленой клюквой и домашним вареньем": {
        "weight": "190 г",
        "description": "Бархатистый паштет из куриной печени с вяленой клюквой. Подаётся с поджаренным хлебом и домашним вареньем."
    },

    # ==================== СЕТ ====================
    "Сет бриошей": {
        "weight": "200 г",
        "description": "Дегустационный сет из мини-бриошей с разными начинками — попробуйте все вкусы нашей авторской линейки."
    },

    # ==================== БРАНЧИ ====================
    "Баварский бранч": {
        "weight": None,
        "description": """Рёбра «Пивные» — 1 порция
Пиво разливное «Де Прусс» — 0,4л"""
    },
    "Немецкий бранч": {
        "weight": None,
        "description": """Кёнигсбергские колбаски — 1 порция
Пиво разливное «Де Прусс» — 0,4л"""
    },

    # ==================== ВЫПЕЧКА ====================
    "Брецель с солью": {
        "weight": "100 г",
        "description": "Традиционный немецкий крендель с крупной солью. Хрустящая корочка и мягкий мякиш."
    },
    "Круассан сливочный": {
        "weight": "80 г",
        "description": "Классический французский круассан из слоёного теста с нежным сливочным маслом."
    },
    "Круассан с нутеллой": {
        "weight": "90 г",
        "description": "Хрустящий слоёный круассан с начинкой из шоколадно-ореховой пасты Нутелла."
    },
    "Булочка с кленовым сиропом и орехом пекан": {
        "weight": "110 г",
        "description": "Сдобная булочка с ароматным кленовым сиропом и хрустящим орехом пекан."
    },
    "Шарлотт яблочный с мороженым": {
        "weight": "200 г",
        "description": "Домашний яблочный пирог с карамелизированными яблоками и корицей. Подаётся тёплым с ванильным мороженым."
    },
    "Тыквенный пирог с мороженым": {
        "weight": "200 г",
        "description": "Нежный пирог из запечённой тыквы со специями. Подаётся тёплым с ванильным мороженым."
    },
    "Вишневый пирог с мороженым": {
        "weight": "180 г",
        "description": "Сочный вишнёвый пирог с кисло-сладкой начинкой. Подаётся тёплым с ванильным мороженым."
    },

    # ==================== ДЕСЕРТЫ ====================
    "Панна Котта с марципаном \"Королева Луиза\"": {
        "weight": "150 г",
        "description": "Итальянский сливочный десерт панна-котта с нежным марципаном в честь королевы Луизы."
    },
    "Чизкейк": {
        "weight": "160 г",
        "description": "Классический нью-йоркский чизкейк с нежной сливочно-сырной начинкой на хрустящей основе."
    },
    "Наполеон «не классический»": {
        "weight": "180 г",
        "description": "Авторская интерпретация классического наполеона — хрустящие слои теста с нежным кремом."
    },
    "Торт фисташка-малина": {
        "weight": "170 г",
        "description": "Изысканный торт с фисташковым муссом и свежей малиной."
    },
    "Сырники с фермерской сметаной и домашним вареньем": {
        "weight": "250 г",
        "description": "Пышные творожные сырники из фермерского творога. Подаются с домашней сметаной и вареньем."
    },
    "Каша дня": {
        "weight": "300 г",
        "description": "Каша дня на цельнозерновом или альтернативном молоке по вашему выбору."
    },
}

async def update_dishes():
    """Обновление описаний и веса блюд"""
    await init_db()

    async with async_session() as session:
        # Получаем все блюда
        result = await session.execute(select(Dish))
        dishes = result.scalars().all()

        updated_count = 0
        not_found = []

        for dish in dishes:
            # Ищем совпадение по названию
            update_data = None

            # Прямое совпадение
            if dish.name in DISH_UPDATES:
                update_data = DISH_UPDATES[dish.name]
            else:
                # Частичное совпадение
                for key, data in DISH_UPDATES.items():
                    key_lower = key.lower()
                    dish_lower = dish.name.lower()

                    if key_lower in dish_lower or dish_lower in key_lower:
                        update_data = data
                        break

                    # Совпадение по ключевым словам
                    key_words = ['клопсы', 'бриошь', 'хот дог', 'похлебка', 'суп', 'скумбри',
                                 'нюрнберг', 'кёнигсберг', 'ребра', 'бургер', 'микс салат',
                                 'утка', 'говядин', 'сельд', 'пеламид', 'бранч']

                    for word in key_words:
                        if word in key_lower and word in dish_lower:
                            if 'балтийские' in key_lower and 'балтийские' in dish_lower:
                                update_data = data
                                break
                            elif 'де прусс' in key_lower and 'де прусс' in dish_lower:
                                update_data = data
                                break
                            elif 'немецкий' in key_lower and 'немецкий' in dish_lower:
                                update_data = data
                                break
                            elif 'баварский' in key_lower and 'баварский' in dish_lower:
                                update_data = data
                                break
                            elif word in ['утка', 'говядин', 'сельд', 'пеламид']:
                                update_data = data
                                break

            if update_data:
                if update_data.get('description'):
                    dish.description = update_data['description']
                if update_data.get('weight'):
                    dish.weight = update_data['weight']

                updated_count += 1
                print(f"✅ Обновлено: {dish.name}")
            else:
                not_found.append(dish.name)

        await session.commit()

        print(f"\n{'='*50}")
        print(f"Обновлено блюд: {updated_count}")
        print(f"Не найдено совпадений: {len(not_found)}")

        if not_found:
            print(f"\nБлюда без описаний:")
            for name in not_found:
                print(f"  - {name}")

if __name__ == "__main__":
    asyncio.run(update_dishes())
